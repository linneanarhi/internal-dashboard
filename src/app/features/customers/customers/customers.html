<div class="space-y-6">
  <!-- =======================================================
    Header
  ======================================================== -->
  <header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h1 class="text-xl font-semibold tracking-tight text-ink">Alla kunder</h1>
      <p class="mt-1 text-sm text-ink3">Filtrera på produkt, sortera och öppna kundkort.</p>
    </div>

    <nav class="flex flex-wrap gap-2" aria-label="Sidåtgärder">
      <a routerLink="/quote/new" class="btn-accent">Skapa offert</a>

    </nav>
  </header>

  <!-- =======================================================
    KPI cards 
  ======================================================== -->
  <section class="hidden lg:grid lg:grid-cols-4 gap-4" aria-label="Sammanfattning">
    <div class="card card-pad">
      <div class="text-sm text-ink3">Totalt kunder</div>
      <div class="mt-2 text-2xl font-semibold text-ink">{{ totalCustomers }}</div>
      <div class="mt-2 text-xs text-ink3">Alla aktiva kunder</div>
    </div>

    <div class="card card-pad">
      <div class="text-sm text-ink3">Totalt användare</div>
      <div class="mt-2 text-2xl font-semibold text-ink">{{ totalUsers }}</div>
      <div class="mt-2 text-xs text-ink3">Alla användare</div>
    </div>

    <div class="card card-pad">
      <div class="text-sm text-ink3">Har samtal</div>
      <div class="mt-2 text-2xl font-semibold text-ink">{{ countCalls }}</div>
      <div class="mt-2 text-xs text-ink3">Kunder med samtal</div>
    </div>

    <div class="card card-pad">
      <div class="text-sm text-ink3">Har mejl</div>
      <div class="mt-2 text-2xl font-semibold text-ink">{{ countEmail }}</div>
      <div class="mt-2 text-xs text-ink3">Kunder med mejl</div>
    </div>
  </section>

  <!-- =======================================================
    Filter
  ======================================================== -->
  <section aria-label="Filter och genvägar">
    <div class="grid gap-3 md:grid-cols-3 items-end">
      <div>
        <label class="label" for="customerSearch">Sök</label>
        <input
          id="customerSearch"
          class="input"
          type="search"
          placeholder="Sök kund, ID, email…"
          [(ngModel)]="query"
        />
      </div>

      <div>
        <label class="label opacity-0" aria-hidden="true">.</label>
        <a routerLink="/quotes" class="btn-secondary h-9.5 w-30 flex items-center justify-center">
          Offerter
        </a>
      </div>
    </div>
  </section>

  <!-- =======================================================
    Mobil
  ======================================================== -->
  <section class="lg:hidden card overflow-hidden" aria-label="Kundlista (mobil)">
    <div class="overflow-x-auto">
      <table class="table">
        <thead class="thead bg-[#ffb7004f]">
          <tr>
            <th class="th text-left">Kund</th>
            <th class="th text-left">Action</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-line2">
          <tr *ngFor="let c of filteredCustomers" class="row cursor-pointer" (click)="openCustomer(c.id)">
            <td class="td">
              <div class="font-semibold text-ink">{{ c.name }}</div>

              <div class="text-xs text-ink3 p-1.5">
                <span *ngFor="let p of c.products" class="pill">
                  {{ labelForProduct(p) }}
                </span>
              </div>

              <div class="mt-2 flex flex-col gap-1">
                <span
                  class="inline-flex w-fit items-center rounded-full px-2 py-1 text-xs font-medium"
                  [ngClass]="flow(c).isActive ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'"
                >
                  {{ flow(c).isActive ? 'Klar' : 'Åtgärd' }}
                </span>

                <span class="text-xs text-ink3">
                  {{ flow(c).nextAction }}
                </span>
              </div>
            </td>

            <td class="td">
              <button type="button" class="btn-accent" (click)="$event.stopPropagation(); openCustomer(c.id)">
                Visa
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- =======================================================
    Desktop
  ======================================================== -->
  <section class="hidden lg:block card overflow-visible" aria-label="Kundlista (desktop)">
    <div class="relative overflow-visible">
      <div class="rounded-xl border border-line bg-white overflow-hidden">
        <table class="w-full border-separate border-spacing-0">
          <thead class="bg-[#ffb7004f]">
            <tr>
              <th class="th text-left rounded-tl-xl">Kund</th>
              <th class="th text-left">ID</th>

              <th class="th text-left">
                <button
                  #productsBtn
                  type="button"
                  class="text-ink hover:underline cursor-pointer inline-flex items-center gap-2"
                  (click)="toggleProducts($event)"
                >
                  Produkter
                  <span class="text-xs text-ink3">
                    {{
                      productFilter !== 'all'
                        ? '(' + labelForProduct(productFilter) + ')'
                        : ''
                    }}
                  </span>
                  <i class="bi bi-caret-down-fill text-xs"></i>
                </button>
              </th>

              <th class="th text-left">Användare</th>

              <th class="th text-left">
                <button
                  type="button"
                  class="text-ink hover:underline focus:outline-none cursor-pointer inline-flex items-center gap-2"
                  (click)="toggleSort('createdAt')"
                >
                  Startdatum
                  <span class="text-ink" aria-hidden="true">
                    <i *ngIf="sortBy === 'createdAt' && sortDir === 'asc'" class="bi bi-caret-up-fill"></i>
                    <i *ngIf="sortBy === 'createdAt' && sortDir === 'desc'" class="bi bi-caret-down-fill"></i>
                  </span>
                </button>
              </th>

              <th class="th text-left">Status</th>
              <th class="th text-left"></th>
              <th class="th text-left rounded-tr-xl">Action</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-line2 bg-white">
            <tr
              *ngFor="let c of filteredCustomers; let isLast = last"
              class="row cursor-pointer hover:[&>td]:bg-line2"
              (click)="openCustomer(c.id)"
            >
              <td class="td bg-white" [class.rounded-bl-xl]="isLast">
                <div class="font-semibold text-ink">{{ c.name }}</div>
                <div class="text-xs text-ink3">{{ c.email }}</div>
              </td>

              <td class="td bg-white text-ink2">{{ c.companyId }}</td>

              <td class="td bg-white">
                <div class="flex flex-wrap gap-1">
                  <span *ngFor="let p of c.products" class="pill">
                    {{ labelForProduct(p) }}
                  </span>
                </div>
              </td>

              <td class="td bg-white text-ink3">{{ c.usersCount }}</td>

              <td class="td bg-white text-ink3">{{ formatDateISO(c.createdAt) }}</td>

              <td class="td bg-white">
                <span
                  class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
                  [ngClass]="flow(c).isActive ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'"
                >
                  {{ flow(c).isActive ? 'Klar' : 'Åtgärd' }}
                </span>
              </td>

              <td class="td bg-white">
                <span class="text-xs text-ink3">
                  <button
                    *ngIf="flow(c).canActivateAgreement"
                    type="button"
                    class="hover:underline text-left"
                    (click)="$event.stopPropagation(); goToActivateAgreement(c)"
                  >
                    {{ flow(c).nextAction }}
                  </button>

                  <span *ngIf="!flow(c).canActivateAgreement">
                    {{ flow(c).nextAction }}
                  </span>
                </span>
              </td>

              <td class="td bg-white" [class.rounded-br-xl]="isLast">
                <button type="button" class="btn-accent bi bi-eye gap-2" (click)="$event.stopPropagation(); openCustomer(c.id)">
                  Visa
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Products dropdown -->
      <div
        *ngIf="productsOpen"
        class="absolute z-50 mt-2 w-56 rounded-md border border-line bg-white shadow-lg"
        [style.left.px]="productsMenuLeft"
        [style.top.px]="productsMenuTop"
        (click)="$event.stopPropagation()"
      >
        <button
          type="button"
          class="block w-full px-3 py-2 text-left text-sm hover:bg-line2"
          (click)="setProductFilter('all'); closeProducts()"
        >
          Alla produkter
        </button>

        <button
          type="button"
          class="block w-full px-3 py-2 text-left text-sm hover:bg-line2"
          (click)="setProductFilter('calls'); closeProducts()"
        >
          Samtal
        </button>

        <button
          type="button"
          class="block w-full px-3 py-2 text-left text-sm hover:bg-line2"
          (click)="setProductFilter('email'); closeProducts()"
        >
          Mejl
        </button>

        <button
          type="button"
          class="block w-full px-3 py-2 text-left text-sm hover:bg-line2"
          (click)="setProductFilter('chat'); closeProducts()"
        >
          Chatt
        </button>

        <button
          type="button"
          class="block w-full px-3 py-2 text-left text-sm hover:bg-line2"
          (click)="setProductFilter('cases'); closeProducts()"
        >
          Ärendeanteckningar
        </button>
      </div>
    </div>
  </section>

  <!-- =======================================================
    Footer
  ======================================================== -->
  <footer
    class="flex flex-col gap-2 border-t border-line px-4 py-3 sm:flex-row sm:items-center sm:justify-between"
    aria-label="Summering"
  >
    <div class="text-xs text-ink3">
      Totalt antal kunder:
      <span class="font-semibold text-ink">{{ totalCustomers }}</span>
      · Totalt antal användare:
      <span class="font-semibold text-ink">{{ totalUsers }}</span>
    </div>

    <div class="text-xs text-ink3">
      Visar <span class="font-semibold text-ink">{{ filteredCustomers.length }}</span> av
      <span class="font-semibold text-ink">{{ totalCustomers }}</span>
    </div>
  </footer>
</div>
